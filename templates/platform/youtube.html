<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YouTube Video Downloader</title>

  <link rel="icon" href="/static/images/youtube.png" type="image/png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/youtube.css">

  <style>
    #toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-in-out;
      z-index: 9999;
    }

    #toast.show {
      opacity: 1;
    }

    body.dark-mode #toast {
      background: #555;
      color: #eee;
    }
  </style>
</head>
<body>
  <header>
    <nav class="navbar bg-dark navbar-dark px-3">
      <div class="navbar-brand d-flex align-items-center">
        <img src="/static/images/youtube.png" alt="Logo" class="icon-logo me-2" style="height: 32px;">
        <span>YouTube Downloader</span>
      </div>
      <div class="d-flex">
        <a href="/" class="btn btn-outline-light me-2">Home</a>
        <a href="/tasks" class="btn btn-outline-light me-2">Tasks</a>
        <button id="themeToggle" class="btn btn-outline-light">🌙</button>
      </div>
    </nav>
  </header>

  <main class="container mt-5">
    <h2 class="text-center mb-4">Paste YouTube Link</h2>
    <form id="link-form" class="row justify-content-center mb-5">
      <div class="col-md-8">
        <input type="url" name="video_url" class="form-control" placeholder="Paste YouTube video or playlist link..." required>
      </div>
      <div class="col-md-2">
        <button type="submit" id="fetchBtn" class="btn btn-primary w-100">Detect</button>
      </div>
    </form>

    <section id="video-list-section" style="display:none;">
      <form id="selection-form">
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label><strong>Apply Quality to All:</strong></label>
            <select id="global-quality" class="form-select">
              <option value="144">144p</option>
              <option value="240">240p</option>
              <option value="360">360p</option>
              <option value="480" selected>480p</option>
              <option value="720">720p</option>
              <option value="1080">1080p</option>
            </select>
          </div>
          <div class="col-md-6">
            <label><strong>Apply Format to All:</strong></label>
            <select id="global-format" class="form-select">
              <option value="video" selected>Video</option>
              <option value="audio">Audio</option>
            </select>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered table-hover align-middle text-center">
            <thead class="table-dark">
              <tr>
                <th><input type="checkbox" id="select-all" /></th>
                <th>Thumbnail</th>
                <th>Title</th>
                <th>Duration</th>
                <th>Quality</th>
                <th>Format</th>
              </tr>
            </thead>
            <tbody id="video-list"></tbody>
          </table>
        </div>

        <div class="text-end">
          <button type="submit" id="downloadSelectedBtn" class="btn btn-success mt-2">Download Selected</button>
        </div>
      </form>
    </section>
  </main>

  <footer>
    <div class="footer-row text-center mt-5 mb-2">
      <a href="/contact">Contact Us</a>
      <span> | </span>
      <a href="/privacy">Privacy Policy</a>
      <span> | </span>
      <a href="mailto:support@example.com">support@example.com</a>
    </div>
    <div class="text-center text-muted mb-3">&copy; 2025 YouTube Downloader. All rights reserved.</div>
  </footer>

  <div id="toast"></div>

  <script>
    const linkForm = document.getElementById('link-form');
    const fetchBtn = document.getElementById('fetchBtn');
    const videoSection = document.getElementById('video-list-section');
    const videoList = document.getElementById('video-list');
    const selectAll = document.getElementById('select-all');
    const selectionForm = document.getElementById('selection-form');
    const globalQuality = document.getElementById('global-quality');
    const globalFormat = document.getElementById('global-format');
    const toast = document.getElementById('toast');

    let videos = [];
    let renderIndex = 0;
    const BATCH_SIZE = 20;
    let source = null;

    function showToast(message) {
      toast.textContent = message;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2500);
    }

    linkForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      fetchBtn.disabled = true;
      fetchBtn.textContent = 'Detecting...';

      const videoUrl = linkForm.querySelector('input[name="video_url"]').value.trim();
      videos = [];
      renderIndex = 0;
      videoList.innerHTML = '';
      videoSection.style.display = 'none';
      if (source) {
        source.close();
        source = null;
      }

      try {
        const res = await fetch('/detect', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ video_url: videoUrl })
        });

        const json = await res.json();
        if (json.error) {
          showToast(json.error);
        } else if (json.type === 'playlist') {
          videoSection.style.display = 'block';
          streamDetect(videoUrl);
          showToast("🎵 Playlist detected — loading videos...");
        } else if (json.type === 'video') {
          videos = [json.video];
          renderMore();
          videoSection.style.display = 'block';
          showToast("✅ Video ready to download!");
        } else {
          showToast("⚠️ Unsupported or unknown video type.");
        }

      } catch (err) {
        showToast("❌ Error detecting video.");
        console.error(err);
      }

      fetchBtn.disabled = false;
      fetchBtn.textContent = 'Detect';
    });

    function streamDetect(videoUrl) {
      fetchBtn.textContent = 'Detecting...';
      source = new EventSource(`/detect-playlist-stream?video_url=${encodeURIComponent(videoUrl)}`);
      source.onmessage = (event) => {
        const video = JSON.parse(event.data);
        videos.push(video);
        if (renderIndex < BATCH_SIZE) renderMore();
      };
      source.addEventListener('thumb', (event) => {
        const data = JSON.parse(event.data);
        const imgEl = document.querySelector(`#video-thumb-${data.id}`);
        if (imgEl && data.thumbnail) imgEl.src = data.thumbnail;
      });
      source.addEventListener('done', () => {
        source.close();
        fetchBtn.disabled = false;
        fetchBtn.textContent = 'Detect';
      });
      source.onerror = (err) => {
        console.error("SSE error:", err);
        source.close();
        fetchBtn.disabled = false;
        fetchBtn.textContent = 'Detect';
      };
    }

    function renderMore() {
      const end = Math.min(renderIndex + BATCH_SIZE, videos.length);
      for (let i = renderIndex; i < end; i++) appendVideo(videos[i], i);
      renderIndex = end;
    }

    function appendVideo(video, index) {
      const thumbnail = video.thumbnail || '/static/images/default-thumbnail.png';
      const title = video.title || 'Untitled';
      const durationFormatted = formatDuration(video.duration || 0);
      const qualityOptions = (video.qualities || ["144", "240", "360", "480", "720", "1080"])
        .map(q => `<option value="${q}" ${q === "480" ? 'selected' : ''}>${q}p</option>`)
        .join('');
      const row = `
        <tr>
          <td><input type="checkbox" name="selected" value="${index}" checked></td>
          <td><img id="video-thumb-${index}" src="${thumbnail}" alt="Thumbnail for ${title}" style="width: 100px;"></td>
          <td>${title}</td>
          <td>${durationFormatted}</td>
          <td><select name="quality-${index}" class="form-select">${qualityOptions}</select></td>
          <td>
            <select name="format-${index}" class="form-select">
              <option value="video" selected>Video</option>
              <option value="audio">Audio</option>
            </select>
          </td>
        </tr>`;
      videoList.insertAdjacentHTML('beforeend', row);
    }

    document.addEventListener('scroll', () => {
      const bottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 100;
      if (bottom && renderIndex < videos.length) renderMore();
    });

    selectAll.addEventListener('change', () => {
      document.querySelectorAll('input[name="selected"]').forEach(cb => cb.checked = selectAll.checked);
    });

    globalQuality.addEventListener('change', () => {
      document.querySelectorAll('select[name^="quality-"]').forEach(sel => sel.value = globalQuality.value);
    });

    globalFormat.addEventListener('change', () => {
      document.querySelectorAll('select[name^="format-"]').forEach(sel => sel.value = globalFormat.value);
    });

    selectionForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const selected = [...document.querySelectorAll('input[name="selected"]:checked')];
      if (!selected.length) return showToast("Please select at least one video.");

      const payload = selected.map(cb => {
        const index = cb.value;
        return {
          ...videos[index],
          format: document.querySelector(`[name="format-${index}"]`).value,
          quality: document.querySelector(`[name="quality-${index}"]`).value
        };
      });

      try {
        const res = await fetch('/download-selected', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ videos: payload })
        });

        const result = await res.json();
        showToast(result.success ? "✅ Download tasks added!" : "❌ " + (result.error || "Something went wrong."));
      } catch (err) {
        showToast("❌ Failed to submit download.");
        console.error(err);
      }
    });

    function formatDuration(sec) {
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      return h > 0 ? `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}` : `${m}:${String(s).padStart(2, '0')}`;
    }
  </script>

  <script>
    const toggleBtn = document.getElementById("themeToggle");
    const currentTheme = localStorage.getItem("theme");

    if (currentTheme === "dark") {
      document.body.classList.add("dark-mode");
      toggleBtn.textContent = "☀️";
    }

    toggleBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      const isDark = document.body.classList.contains("dark-mode");
      toggleBtn.textContent = isDark ? "☀️" : "🌙";
      localStorage.setItem("theme", isDark ? "dark" : "light");
    });
  </script>
</body>
</html>
